/**
 * @fileoverview Firestore Security Rules for the MAKI e-commerce application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user-specific data
 * (profiles, orders, order items) and restricts administrative actions to
 * authenticated admin users. Public read access is granted to product and shop
 * location data, but modification is limited to admins.
 *
 * Data Structure:
 * - /products/{productId}: Product information, publicly readable, admin-writeable.
 * - /users/{userId}: User profiles, only accessible by the owning user.
 * - /users/{userId}/orders/{orderId}: User orders, only accessible by the owning user.
 * - /users/{userId}/orders/{orderId}/orderItems/{orderItemId}: Order items, only accessible by the owning user.
 * - /shopLocations/{shopLocationId}: Shop location information, publicly readable, admin-writeable.
 * - /admins/{userId}: Collection of admin users. Presence in this collection grants admin privileges.
 *
 * Key Security Decisions:
 * - Public listing of products and shop locations.
 * - Strict ownership enforcement for user profiles and associated data.
 * - Administrative privileges granted based on presence in the /admins collection.
 * - No user listing is allowed.
 *
 * Denormalization for Authorization:
 * - Admin status is determined by the existence of a document in the `/admins/{userId}` collection. This avoids complex queries in the rules.
 *
 * Structural Segregation:
 * - User data (private) is stored under /users/{userId}, while product and shop location data (public) are stored in top-level collections.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @example isSignedIn() == true if request.auth != null
     * @example isSignedIn() == false if request.auth == null
     * @principle Authentication is required for certain operations.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user ID matches the requested user ID.
     * @param {string} userId - The user ID to compare against.
     * @return {boolean} True if the user ID matches, false otherwise.
     * @example isOwner("some_user_id") == true if request.auth.uid == "some_user_id"
     * @example isOwner("another_user_id") == false if request.auth.uid == "some_user_id"
     * @principle Ensures that users can only access their own data.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is an admin by verifying their presence in the /admins collection.
     * @return {boolean} True if the user is an admin, false otherwise.
     * @example isAdmin() == true if get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.exists()
     * @example isAdmin() == false if get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.exists()
     * @principle Restricts administrative actions to authorized users.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    /**
     * @description Checks if the user is an admin by verifying their presence in the /admins collection.
     * @param {string} document - The document to check if it exists
     * @return {boolean} True if the user is an admin, false otherwise.
     * @example isAdmin() == true if get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.exists()
     * @example isAdmin() == false if get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.exists()
     * @principle Restricts administrative actions to authorized users.
     */
    function isExistingDocument(document) {
      return exists(document);
    }

    /**
     * @description Security rules for the /products collection.
     * @path /products/{productId}
     * @allow (get, list) - Any user can read product information.
     * @allow (create, update, delete) - Only an admin can modify product information.
     * @deny (create, update, delete) - A non-admin user attempts to modify product information.
     * @principle Allows public read access but restricts write access to admins.
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Security rules for the /users collection.
     * @path /users/{userId}
     * @allow (get, update, delete) - The user can read and modify their own profile.
     * @allow (create) - The user can create their own profile if the userId matches their auth.uid.
     * @deny (get, update, delete) - A user attempts to access another user's profile.
     * @deny (create) - A user attempts to create a profile with a userId that doesn't match their auth.uid.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      allow get, update, delete: if isOwner(userId) && isExistingDocument(resource);
      allow create: if isOwner(userId);
      allow list: if false;
    }

    /**
     * @description Security rules for the /users/{userId}/orders collection.
     * @path /users/{userId}/orders/{orderId}
     * @allow (get, list, create, update, delete) - The user can manage their own orders.
     * @deny (get, list, create, update, delete) - A user attempts to access another user's orders.
     * @principle Enforces document ownership for user orders.
     */
    match /users/{userId}/orders/{orderId} {
      allow get, list, create, update, delete: if isOwner(userId) && isExistingDocument(resource);
    }

    /**
     * @description Security rules for the /users/{userId}/orders/{orderId}/orderItems collection.
     * @path /users/{userId}/orders/{orderId}/orderItems/{orderItemId}
     * @allow (get, list, create, update, delete) - The user can manage their own order items.
     * @deny (get, list, create, update, delete) - A user attempts to access another user's order items.
     * @principle Enforces document ownership for user order items.
     */
    match /users/{userId}/orders/{orderId}/orderItems/{orderItemId} {
      allow get, list, create, update, delete: if isOwner(userId) && isExistingDocument(resource);
    }

    /**
     * @description Security rules for the /shopLocations collection.
     * @path /shopLocations/{shopLocationId}
     * @allow (get, list) - Any user can read shop location information.
     * @allow (create, update, delete) - Only an admin can modify shop location information.
     * @deny (create, update, delete) - A non-admin user attempts to modify shop location information.
     * @principle Allows public read access but restricts write access to admins.
     */
    match /shopLocations/{shopLocationId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Security rules for the /admins collection.
     * @path /admins/{userId}
     * @allow (create) - An admin can be added.
     * @allow (get, list, update, delete) - Admins can manage the admin list.
     * @deny (create, get, list, update, delete) - Non-admins cannot manage the admin list.
     * @principle Restricts management of admin roles to existing admins.
     */
    match /admins/{userId} {
      allow get, list, create, update, delete: if isAdmin();
    }
  }
}